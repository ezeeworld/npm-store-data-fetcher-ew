#!/bin/bash

# google/test contains private content
# apple/test contains private content

DIR=$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )/..

(cd "$DIR" && eslint .) || exit 1
(cd "$DIR" && npm test) || exit 1
(cd "$DIR" && npm run test_google) || exit 1

# run apple tests manually
# (cd "$DIR" && npm run test_apple) || exit 1

rm -r "$DIR/release" 2>/dev/null
mkdir "$DIR/release" || exit 1
cp "$DIR/package.json" "$DIR/release" || exit 1
cp "$DIR/storeDataFetcher.js" "$DIR/release" || exit 1
mkdir "$DIR/release/google" || exit 1
mkdir "$DIR/release/google/test" || exit 1
cp "$DIR/google/test/gsync.js" "$DIR/release/google/test" || exit 1
cp "$DIR/google/gsync.js" "$DIR/release/google" || exit 1
cp "$DIR/google/README.md" "$DIR/release/google" || exit 1
mkdir "$DIR/release/apple" || exit 1
mkdir "$DIR/release/apple/test" || exit 1
cp "$DIR/apple/test/getAppStoreReport.js" "$DIR/release/apple/test" || exit 1
cp "$DIR/apple/getAppStoreReport.js" "$DIR/release/apple" || exit 1
cp "$DIR/apple/promiseUtils.js" "$DIR/release/apple" || exit 1
cp "$DIR/apple/README.md" "$DIR/release/apple" || exit 1
npm publish "$DIR/release" || exit 1